#!/bin/bash

set -e -o pipefail

rm -rf tmp/build
mkdir -p tmp/build
git archive --format=tar main | tar x -C tmp/build/
cd tmp/build

docker build -f Dockerfile.releaser -t nerves_hub_www:releaser .

export DOCKER_UUID=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1)
docker run -ti --name "nerves_hub_www_releaser_${DOCKER_UUID}" nerves_hub_www:releaser /bin/true
docker cp "nerves_hub_www_releaser_${DOCKER_UUID}":/opt/nerves_hub_www.tar.gz ../
docker rm "nerves_hub_www_releaser_${DOCKER_UUID}"
